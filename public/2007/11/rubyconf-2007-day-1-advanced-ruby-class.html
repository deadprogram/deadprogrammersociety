<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>RubyConf 2007 - Day 1 - &#34;Advanced Ruby Class Design&#34; - Jim Weirich - Dead Programmer SOciety</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" href="/favicon.png">
  <link rel="canonical" href="/2007/11/rubyconf-2007-day-1-advanced-ruby-class.html" />

  
  
  <link rel="stylesheet" href="/css/style.min.6b89cc86c0b843a772cdd6c6a8b7e11c2116c7933f6163d2ef225a87e1d2c121.css">
  

  
    
    <meta property="og:title" content="RubyConf 2007 - Day 1 - &#34;Advanced Ruby Class Design&#34; - Jim Weirich"/>
    <meta property="og:type" content="website"/>
    <meta property="og:url" content="/2007/11/rubyconf-2007-day-1-advanced-ruby-class.html"/>
    
    
    <meta name="twitter:card" content="summary"/>
    <meta name="twitter:site" content="@deadprogram"/>
    <meta name="twitter:creator" content="@deadprogram"/>
  

  <link rel="preconnect" href="https://fonts.gstatic.com">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;700&display=swap" rel="stylesheet"> 
</head>




<body class='page frame page-blog-single'>
  <div id="menu-main-mobile" class="menu-main-mobile">
    <ul class="menu">
        
        
            
                <li class="menu-item-home">
                    <a href="/">Home</a>
                </li>
            
        
            
                <li class="menu-item-blog">
                    <a href="/posts/">Blog</a>
                </li>
            
        
            
                <li class="menu-item-about">
                    <a href="/about/">About</a>
                </li>
            
        
            
                <li class="menu-item-tags">
                    <a href="/tags/">Tags</a>
                </li>
            
        
    </ul>
</div>
  <div id="wrapper" class="wrapper">
    <div class='header'>
  <a class="header-logo" href="/">Dead Programmer SOciety</a>
  <div class="menu-main">
    <ul>
      
      
      
      
      <li class="menu-item-home ">
        <a href="/">
          
          <span>Home</span>
        </a>
      </li>
      
      
      
      <li class="menu-item-blog ">
        <a href="/posts/">
          
          <span>Blog</span>
        </a>
      </li>
      
      
      
      <li class="menu-item-about ">
        <a href="/about/">
          
          <span>About</span>
        </a>
      </li>
      
      
      
      <li class="menu-item-tags ">
        <a href="/tags/">
          
          <span>Tags</span>
        </a>
      </li>
      
    </ul>
  </div>
  <div id="toggle-menu-main-mobile" class="hamburger-trigger">
    <button class="hamburger">Menu</button>
  </div>
</div>
    
  <div class="blog">
    
    <div class="intro">
      <h1>RubyConf 2007 - Day 1 - &#34;Advanced Ruby Class Design&#34; - Jim Weirich<span class="dot">.</span></h1>
      
    </div>
    <div class="content">
      <p><a href="http://images.43things.com/profile/59820s160.jpg"><img src="http://images.43things.com/profile/59820s160.jpg" alt=""></a><a href="http://onestepback.org/">Jim Weirich</a> is a very smart guy. So smart that his presentation was not about complicated classes, but about Ruby itself and how to take advantage of it to simplify things. Jim&rsquo;s background in computing is long and varied, something like a history lesson in programming languages. Here is the abbreviated list:</p>
<p>FORTRAN &gt; C &gt; Modula 2 &gt; C++ &gt; Eiffel &gt; Java<br>
and in parallel to this:<br>
LISP &gt; FORTH &gt; TCL &gt; Perl</p>
<p>Jim got started programming taking an introduction to FORTRAN class that just so happenened to be taught by <a href="http://en.wikipedia.org/wiki/Daniel_P._Friedman">Daniel Friedman</a>, author of &ldquo;The Little LISPer&rdquo;. As such, they studied LISP for the first half of the semester. They did finally get around to FORTRAN, where Jim learned firsthand the adage:</p>
<p>&ldquo;A real programmer can write FORTRAN (Java) in any language&rdquo;</p>
<p>Jim took us thru three examples that illustrate some very cool techniques to use as part of elegant class design in Ruby.</p>
<p><strong>Box 1. Rake::FileList</strong><br>
Everyone knows and loves Rake, right? Rake::FileList is like an array but:<br>
- can init with GLOB (an array of filenames, created using a pattern match expression)<br>
- has a specialized to_s<br>
- has extra methods<br>
- uses lazy evaluation</p>
<p>In his first cut, Jim derived from Array:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">  
class FileList &gt; Array  
 ...  
end  

</code></pre></div><p>Here is the first implementation for FileList:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">  
class FileList &gt; Array  
 def initialize(pattern)  
  super  
  @pattern = pattern  
  @resolve = false  
 end  
  
 def resolve  
  self.clear  
  Dir\[@pattern\].each do |file|  
   ...  
  end  
 end  
end  

</code></pre></div><p>The problem is this:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">  
f1 = FileList.new(&#34;\*.c&#34;)  

</code></pre></div><p>won&rsquo;t work, cause we never call &ldquo;resolve&rdquo;. What we need to do is to do some lazy loading to &ldquo;auto resolve&rdquo;, like this:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">  
def \[\](index)  
 resolve if ! @resolve  
end  

</code></pre></div><p>Lots of methods need to call resolve in this manner&hellip; which is a problem that Jim solves later using a little metaprogramming.</p>
<p>But there is a another problem with the current implementation. This is OK:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">  
f1 = FileList.new(&#39;\*.rb&#39;)  
f1 + \[&#39;thing.rb&#39;\]  

</code></pre></div><p>But this is NOT:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">  
f1 = FileList.new(&#39;\*.rb&#39;)  
\[&#39;thing.rb&#39;\] + f1  

</code></pre></div><p>Why? Because the + method requires passing a literal array to it as an argument, not an object of class Array. If only there was a way for an arbitrary object could indicate that it wants to be treated like an array&hellip; ah, but there is! The &ldquo;to_ary&rdquo; method was designed to do exactly this. The problem is you cannot call the to_ary method on an Array. The solution is not to derive the FileList class from Array, but instead to use the &ldquo;to_ary&rdquo; method to access an Array that is encapsulated into the FileList class.</p>
<p>Another shortcut is instead of calling resolve on each method, using some metaprogramming to add the &ldquo;resolve&rdquo; call to every method that might need it, like this:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">  
RESOLVING\_METHODS = \[:this, :that\]  
RESOLVING\_METHODS.each do |method|  
 ...  
end  

</code></pre></div><p>The big lesson here is when trying to mimic a class, use &ldquo;to_ary&rdquo; and &ldquo;to_str&rdquo; rather than inheritance.</p>
<p><strong>Box 2 - The Art of Doing Nothing</strong><br>
Builder is a very cool library which is part of the standard Ruby library to create XMl files, but using a friendly Ruby syntax. Did I mention that Jim is the original creator of Builder? Here is an example of Builder in use, if you are not familiar with it:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">  
xml = Builder::XmlMarkup.new(:indent =&gt;2)  
xml.student {  
 xml.name(&#34;Jim&#34;)  
 xmp.phone\_number  
}  

</code></pre></div><p>Builder uses method_missing to construct tags. This works really well&hellip; except what happens if you try to use it with a predefined method? method_missing will not work anymore, since the method is actually there.</p>
<p>Jim solution is to &ldquo;inherit from Object without actually inheriting from Object&rdquo;, a class he calls BlankSlate. We want to have our Builder class inherit from BlankSlate, instead of Object.</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">  
class BlankSlate  
 instance\_methods.each do |method|  
  undef\_method(method)  
 end  
end  

</code></pre></div><p>That does indeed get rid of all of the methods on the class. But that does not work, because there are some internal methods that Ruby needs that we do not want to get rid of, so we extend the class to this:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">  
class BlankSlate  
 instance\_methods.each do |method|  
  undef\_method(method) unless name =~ /~\_\_/  
 end  
end  

</code></pre></div><p>This is not the only problem, however. Since in Ruby classes are open, we can also extend them using Modules.</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">  
require &#39;blank\_slate&#39;  
  
module Kernel  
 def name  
  &#34;hi&#34;  
 end  
end  
  
xml.name(&#34;Jim&#34;)  
  
class BlankSlate  
 def self.hide(method)  
  ...  
 end  
   
 instance\_methods.each do |method|  
  undef\_method(method) unless method =~ /^\_\_/  
 end  
end  
  
  
module Kernel  
 class &lt;&lt; self  
  alias\_method :original\_method\_added, :method\_added  
    
  def method\_added(name)  
   result = original\_method\_added(name)  
   BlankSlate.hide(name) if self == Kernel  
   result  
  end  
 end  
end  

</code></pre></div><p>We will need to do something similar for Object, in order to avoid the same problem. So are we done? Not quite, there is still one more thing&hellip; but I didn&rsquo;y quite catch what it was! I will update this when Jim puts his slides up:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">  
require &#39;blank\_slate&#39;  
  
module Kernel  
 def name  
  &#34;hi&#34;  
 end  
end  
  
class Object  
 include Name  
end  
...  
xml.name(&#34;Jim&#34;)  

</code></pre></div><p>Hint: Use #append_features to modify open classes.</p>
<p><strong>Box 3 - Parsing Without Parsing</strong><br>
ActiveRecord is a wonderful abstraction to use, but why is it that we use such a non-Ruby-like technique to select records. For example, we would use this in Rails:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">  
User.find(:all, :conditions =&gt; \[&#34;name = ?&#34;, &#39;jim&#39;\])  

</code></pre></div><p>Versus using a more standard Ruby language enumerable approach, like this:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">  
user\_list.select { |user|  
 user.name == &#34;jim&#34;  
}  

</code></pre></div><p>Wouldn&rsquo;t it be nicer to do something like this:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">  
User.select { |user|  
 user.name == &#34;Jim&#34;  
}  

</code></pre></div><p>Jim starts out with a naive implementation, like this:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">  
class User  
 def self.select(&amp;blk)  
  find(:all).select(&amp;blk)  
 end  
end  

</code></pre></div><p>There are several problems, not the least of which is that the above code is far from efficient. A large set of results will use an enormous amount of memory.</p>
<p>Jim then goes on to show a properly &ldquo;magic&rdquo; implementation:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">  
class User  
 def self.select(&amp;blk)  
  cond = translate\_block\_to\_sql(&amp;blk)  
  find(:all, :conditions =&gt; cond)  
 end  
end  

</code></pre></div><p>How to implement the magic translate_block_to_sql method?<br>
- write a parser yourself<br>
- Use Parse Tree (Ambition project)<br>
- Just execute the code in the block</p>
<p>As one might suspect, the answer is of course &ldquo;just execute the code&rdquo;. In other words, create appropriate methods that are called when the block is executed to return the correct SQL conditions clause for the query. Let me warn you, dear reader, that I typed as fast as I could, but some of the code examples here are a little incomplete. As soon as Jim posts his slides online, I will revise and complete them.</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">  
class User  
 def self.select(&amp;blk)  
  cond = translate\_block\_to\_sql(&amp;blk)  
  find(:all, :conditions =&gt; cond)  
 end  
  
 def translate\_block\_to\_sql(&amp;blk)  
  instance\_eval(&amp;blk) # this is not exactly the code, but I couldn&#39;t type fast enough!  
 end  
end  
  
class MethodNode &lt; Node  
 def to\_s  
  ...  
 end  
end  

</code></pre></div><p>OK, now what about the &ldquo;==&rdquo; operator?</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">  
class Node  
 def ==(other)  
  BinaryOpNode.new(&#34;=&#34;, self, other)  
 end  
end  
  
class BinaryOpNode &lt; Node  
 def initialize(operand, left, right)  
  @operand = operand  
  @left = left  
  @right = right  
 end  
   
 def to\_s  
  &#34;#{@left} #{@operand} #{@right}&#34;  
 end  
end  
  
class LiternalNode &lt; Node  
 ...  
end  
  
class StringNode &lt; Node # puts quotes around the string for SQL query  
 ...  
end  

</code></pre></div><p>Do not use a case statement to differentiate between types. Instead open core classes, like this:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">  
class Object  
 def as\_a\_sql\_node  
  ...  
 end  
end  
  
class String  
 def as\_a\_sql\_node  
  ...  
 end  
end  

</code></pre></div><p>Be careful how you name methods to avoid collisions.</p>
<p>Possible problems? Literals on left, because &ldquo;==&rdquo; is commutative. The solution is to use &ldquo;coerce&rdquo; method to handle numeric operators.</p>
<p>More possible problems?<br>
&ldquo;&amp;&amp;&rdquo; and &ldquo;||&rdquo; operators cannot be overridden in Ruby cause they have short-circuit semantics in the Ruby language interpreter itself. Perhaps &amp; and | instead? Too bad, because we have to write &ldquo;special&rdquo; semantics. Also &ldquo;!&rdquo; and &ldquo;!=&rdquo; cannot be overridden in Ruby</p>
<p>The ruby &ldquo;criteria' lib already implements some of these ideas.</p>
<p><strong>Conclusion</strong><br>
One important lesson to take away, is that programming languages really shape the way we approach problems. Learn the corners of whatever language you are using to take full advantage of it. Don&rsquo;t be afraid to think outside the box of past experience&hellip;</p>
<p>Jim was an amazing and dynamic speaker. All I can say is <a href="http://objo.com/">Joe O&rsquo;Brian</a> and the people at <a href="http://theedgecase.com/">EdgeCase</a> are very fortunate to have him around.</p>

    </div>
  </div>

    <div class="footer">
  
  <div class="footer-social">
    
      <span class="social-icon social-icon-twitter">
        <a href="https://twitter.com/deadprogram" title="twitter" target="_blank" rel="noopener">
          <img src="/images/social/twitter.svg" width="24" height="24" alt="twitter"/>
        </a>
      </span>
    
      <span class="social-icon social-icon-github">
        <a href="https://github.com/deadprogram" title="github" target="_blank" rel="noopener">
          <img src="/images/social/github.svg" width="24" height="24" alt="github"/>
        </a>
      </span>
    
      <span class="social-icon social-icon-linkedin">
        <a href="https://www.linkedin.com/in/deadprogram/" title="linkedin" target="_blank" rel="noopener">
          <img src="/images/social/linkedin.svg" width="24" height="24" alt="linkedin"/>
        </a>
      </span>
    
  </div>
  
</div>
  </div>

  

  

  
  <script type="text/javascript" src="/js/bundle.min.575671c6da23c3563d465f9cfa3d2857fc0239531a2e8ea1fb6812017653b4d7.js"></script>
  

  
  

  
  
  
    
  

  


</body>
</html>